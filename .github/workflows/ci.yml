name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Test vespera-scriptorium package
  test-vespera-scriptorium:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('packages/vespera-scriptorium/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      working-directory: packages/vespera-scriptorium
      run: |
        python3 -m pip install --upgrade pip || python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run linting
      working-directory: packages/vespera-scriptorium
      run: |
        black --check vespera_scriptorium/
        isort --check-only vespera_scriptorium/
        flake8 vespera_scriptorium/
    
    - name: Run type checking
      working-directory: packages/vespera-scriptorium
      continue-on-error: true  # Allow mypy to fail for now
      run: |
        mypy vespera_scriptorium/
    
    - name: Run tests
      working-directory: packages/vespera-scriptorium
      run: |
        pytest tests/unit/ tests/integration/test_complete_task.py tests/integration/test_orchestrator.py tests/integration/test_task_execution.py -v --cov=vespera_scriptorium --cov-report=xml
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: packages/vespera-scriptorium/coverage.xml
        flags: vespera-scriptorium
        name: codecov-umbrella

  # Test vespera-utilities package  
  test-vespera-utilities:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20', '21']
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install dependencies
      working-directory: vespera-utilities
      run: npm ci
    
    - name: Run linting
      working-directory: vespera-utilities
      run: npm run lint
    
    - name: Run type checking
      working-directory: vespera-utilities
      run: npm run type-check
    
    - name: Run tests
      working-directory: vespera-utilities
      run: npm test

  # Test Obsidian plugin
  test-obsidian-plugin:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      working-directory: plugins/Obsidian/Vespera-Scriptorium
      run: npm ci
    
    - name: Run linting
      working-directory: plugins/Obsidian/Vespera-Scriptorium
      continue-on-error: true  # Allow linting to fail for now
      run: npm run lint
    
    - name: Run type checking
      working-directory: plugins/Obsidian/Vespera-Scriptorium
      run: npm run build

  # Integration tests across packages
  integration-tests:
    runs-on: ubuntu-latest
    needs: [test-vespera-scriptorium]
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Node.js  
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Python dependencies
      working-directory: packages/vespera-scriptorium
      run: |
        python3 -m pip install --upgrade pip || python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Install Node dependencies (utilities)
      working-directory: vespera-utilities
      run: npm ci
    
    - name: Run integration tests
      working-directory: packages/vespera-scriptorium
      run: |
        # Run a subset of integration tests that don't require complex setup
        pytest tests/integration/test_complete_task.py -v
    
    - name: Test CLI functionality
      working-directory: packages/vespera-scriptorium
      run: |
        # Test basic CLI functionality
        python3 -m vespera_scriptorium_cli --help || python -m vespera_scriptorium_cli --help
        vespera-scriptorium --help

  # Security and quality checks
  security-checks:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        python3 -m pip install --upgrade pip || python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Run Bandit security scan
      working-directory: packages/vespera-scriptorium
      run: |
        bandit -r vespera_scriptorium/ -f json -o bandit-report.json || true
    
    - name: Check for known vulnerabilities
      working-directory: packages/vespera-scriptorium
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          packages/vespera-scriptorium/bandit-report.json
          packages/vespera-scriptorium/safety-report.json

  # Build and validate packages
  build-packages:
    runs-on: ubuntu-latest
    needs: [test-vespera-scriptorium, test-vespera-utilities, test-obsidian-plugin]
    
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Build Python package
      working-directory: packages/vespera-scriptorium
      run: |
        python3 -m pip install --upgrade pip build || python -m pip install --upgrade pip build
        python3 -m build || python -m build
    
    - name: Validate package
      working-directory: packages/vespera-scriptorium
      run: |
        pip install twine
        twine check dist/*
    
    - name: Setup Node.js for utilities build
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build utilities package
      working-directory: vespera-utilities
      run: |
        npm ci
        npm run build
    
    - name: Build Obsidian plugin
      working-directory: plugins/Obsidian/Vespera-Scriptorium
      run: |
        npm ci
        npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          packages/vespera-scriptorium/dist/
          vespera-utilities/dist/
          plugins/Obsidian/Vespera-Scriptorium/dist/