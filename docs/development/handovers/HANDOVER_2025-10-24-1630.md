# Context Handover: October 24, 2025 16:30

## üéØ Current Focus
Phase 17 architectural foundation - refactoring Phase 16b's Project/Context model before implementing the Codex Editor.

## ‚úÖ Just Completed
- **Created ADR-015**: Workspace/Project/Context Hierarchy
  - Documents three-level architecture (Workspace ‚Üí Project ‚Üí Context)
  - Projects = real-world endeavors, Contexts = organizational lenses
  - Codices belong to Projects, appear in Contexts (many-to-many)
  - [ADR-015](../decisions/ADR-015-workspace-project-context-hierarchy.md)

- **Created ADR-016**: Global Registry + Workspace Storage Architecture
  - Global registry in OS user directory (~/.vespera/)
  - Platform-specific paths (Windows/macOS/Linux)
  - Discovery algorithm for flexible VS Code folder opening
  - [ADR-016](../decisions/ADR-016-global-registry-storage.md)

- **Updated Phase 17 Plan**: Refactored to two-part phase
  - Part 1: Architectural Refactoring (NEW - 3-5 hours)
  - Part 2: Editor Implementation (original goals)
  - Timeline updated: 16-23 hours (~3 context windows)
  - [PHASE_17_PLAN.md](../phases/PHASE_17_PLAN.md)

- **Updated ADR README**: Added Phase 17 section with new ADRs

- **Created `/resume` command**: Complementary command to `/handover` for next session

- **All changes committed**: Ready to push (29 commits ahead of origin)

## üöß In Progress
**Current Task**: None - planning phase complete, ready for implementation
**Status**: 100% planning complete, 0% implementation started

## ‚ö†Ô∏è Blockers / Issues
None - architecture is well-defined and ready for implementation.

## üìã Next Up (Priority Order)

### Stage 0: Architectural Refactoring (MUST DO FIRST)

1. **Refactor Database Schema** (1-2 hours)
   - Read current schema in BinderyService
   - Add `projects` table (real-world endeavors)
   - Rename `projects` table to `contexts` (organizational lenses)
   - Add `codex_contexts` many-to-many join table
   - Update all foreign key relationships
   - See ADR-015 for exact schema

2. **Implement Global Registry** (1-2 hours)
   - Create `~/.vespera/registry.json` structure
   - Implement platform-specific path detection (Windows/macOS/Linux)
   - Build sync mechanism between global registry and workspace data
   - Add registry persistence (read/write)
   - See ADR-016 for implementation details

3. **Implement Workspace Discovery** (1 hour)
   - Discovery algorithm:
     1. Check for `.vespera/` in current workspace
     2. Search up directory tree (max 5 levels)
     3. Check global registry for projects in current path
     4. Prompt to initialize if not found
   - See ADR-016 for algorithm details

4. **Create Migration Script** (30-60 min)
   - Migrate Phase 16b "Projects" ‚Üí Phase 17 "Contexts"
   - Create default Project for existing workspaces
   - Preserve all existing Codex data
   - Test migration on sample data

5. **Update UI Components** (1 hour)
   - Add Project selector to Navigator header
   - Keep Context switcher (formerly Project switcher)
   - Update status bar to show Project + Context
   - Wire up selection handlers

6. **Update Bindery Integration** (30 min)
   - Update all JSON-RPC calls to use new schema
   - Update TypeScript types for Projects/Contexts
   - Test basic CRUD operations

7. **Test & Validate** (30 min)
   - Create test workspace with multi-context project
   - Verify discovery algorithm works
   - Test global registry sync
   - Verify Codices appear in multiple Contexts

8. **Documentation** (30 min)
   - Update user guide with new concepts
   - Document migration process
   - Update any examples referencing "Projects"

### Stage 1-4: Editor Implementation (AFTER REFACTORING)
See [PHASE_17_PLAN.md](../phases/PHASE_17_PLAN.md) for details.

## üß† Mental Model

**Critical Realization**: Phase 16b's "Projects" were actually "Contexts" within real-world projects.

**Example Use Case**:
- **Project**: "Mythology-Based Video Game"
  - **Context**: Story Development (fiction templates)
  - **Context**: Mythology Research (research templates)
  - **Context**: Code Implementation (code file templates)
  - **Context**: Art & Assets (asset templates)

**Why Refactor Before Editor?**
- Building editor on flawed architecture compounds technical debt
- Correcting conceptual model now prevents confusion later
- Many-to-many Codex-Context relationship is essential for real-world workflows
- Global registry enables cross-workspace project tracking

**Architecture Layers**:
1. **Workspace** - Physical directory with `.vespera/` folder
2. **Project** - Real-world creative endeavor (game, novel, research paper)
3. **Context** - Organizational lens within project (story, research, code)
4. **Codex** - Individual content entry belonging to project, appearing in contexts

## üìö Key Files for Context

**Read These First**:
1. [PHASE_17_PLAN.md](../phases/PHASE_17_PLAN.md) - Complete phase overview
2. [ADR-015: Workspace/Project/Context Hierarchy](../decisions/ADR-015-workspace-project-context-hierarchy.md) - Database schema
3. [ADR-016: Global Registry + Workspace Storage](../decisions/ADR-016-global-registry-storage.md) - Storage architecture

**Current Implementation Files** (will be refactored):
4. [src/services/bindery/BinderyService.ts](../../vespera-forge/src/services/bindery/BinderyService.ts) - Current schema
5. [src/services/ProjectContext.ts](../../vespera-forge/src/services/ProjectContext.ts) - Will become "ContextService"
6. [src/views/NavigatorWebviewProvider.ts](../../vespera-forge/src/views/NavigatorWebviewProvider.ts) - UI updates needed

**Architecture Documentation**:
7. [PROJECT_CENTRIC_ARCHITECTURE.md](../architecture/core/PROJECT_CENTRIC_ARCHITECTURE.md) - Now applies to "Projects" properly
8. [HIERARCHICAL_TEMPLATE_SYSTEM.md](../architecture/core/HIERARCHICAL_TEMPLATE_SYSTEM.md) - Template filtering by context

## üí° Quick Wins

- **Use Subagents**: Stage 0 has 8 discrete tasks perfect for subagent orchestration
- **Schema is well-defined**: ADR-015 has exact SQL
- **Discovery algorithm is clear**: ADR-016 has TypeScript pseudocode
- **Migration is straightforward**: Just rename + add layer
- **File-backed Codices already planned**: Content in filesystem, metadata in database

## ‚è∞ Time-Sensitive Items

None - this is refactoring work, no external deadlines.

## üéØ Recommended Subagent Strategy

**Main Orchestrator** (this context):
- Coordinate overall Stage 0 progress
- Review subagent work
- Make architectural decisions
- Track todo list

**Subagent 1**: Database Schema Refactoring
- Task: Implement new schema (projects/contexts/codex_contexts)
- Deliverable: Updated BinderyService with new tables

**Subagent 2**: Global Registry Implementation
- Task: Create ~/.vespera/ registry with platform-specific paths
- Deliverable: GlobalRegistry service class

**Subagent 3**: Discovery Algorithm
- Task: Implement workspace discovery (workspace ‚Üí tree ‚Üí registry ‚Üí init)
- Deliverable: WorkspaceDiscovery service class

**Subagent 4**: Migration Script
- Task: Migrate Phase 16b data to Phase 17 schema
- Deliverable: migration.ts script + test data

**Subagent 5**: UI Updates
- Task: Add Project selector, update Context switcher
- Deliverable: Updated Navigator UI components

**Subagent 6**: Testing & Validation
- Task: Test all refactoring components together
- Deliverable: Test results, bug fixes

## üîß Technical Context

**Current Phase 16b Schema** (BEFORE refactoring):
```sql
CREATE TABLE projects (  -- These are actually "Contexts"!
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  template_type TEXT NOT NULL,  -- e.g., "fiction", "research"
  icon TEXT,
  color TEXT
);

CREATE TABLE codices (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,  -- One-to-one relationship
  title TEXT NOT NULL,
  content TEXT,
  FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

**Phase 17 Schema** (AFTER refactoring - see ADR-015):
```sql
CREATE TABLE projects (  -- Real-world endeavors
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  active_context_id TEXT,
  FOREIGN KEY (workspace_id) REFERENCES workspaces(id)
);

CREATE TABLE contexts (  -- Organizational lenses
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  name TEXT NOT NULL,
  template_type TEXT NOT NULL,  -- e.g., "fiction", "research"
  icon TEXT,
  color TEXT,
  FOREIGN KEY (project_id) REFERENCES projects(id)
);

CREATE TABLE codex_contexts (  -- Many-to-many
  codex_id TEXT NOT NULL,
  context_id TEXT NOT NULL,
  is_primary BOOLEAN DEFAULT FALSE,
  PRIMARY KEY (codex_id, context_id),
  FOREIGN KEY (codex_id) REFERENCES codices(id) ON DELETE CASCADE,
  FOREIGN KEY (context_id) REFERENCES contexts(id) ON DELETE CASCADE
);

CREATE TABLE codices (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,  -- Belongs to project
  title TEXT NOT NULL,
  content TEXT,
  file_path TEXT,  -- NEW: for file-backed Codices
  FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

**Global Registry Structure** (see ADR-016):
```json
{
  "version": "1.0",
  "projects": [
    {
      "id": "proj_uuid",
      "name": "Mythology-Based Video Game",
      "workspace_path": "/home/user/projects/game-dev",
      "last_accessed": "2025-10-24T16:30:00Z",
      "contexts": [
        {"id": "ctx_story", "name": "Story Development"},
        {"id": "ctx_research", "name": "Mythology Research"},
        {"id": "ctx_code", "name": "Code Implementation"}
      ]
    }
  ]
}
```

## üöÄ Architectural Decisions Context

**Why Three Levels?**
- Workspace = physical location (like a Git repo)
- Project = conceptual boundary (like a GitHub project)
- Context = organizational mode (like Git branches, but for content type)

**Why Global Registry?**
- User may open VS Code at project subfolder
- Need to know which project this path belongs to
- Cross-workspace awareness (list all projects)
- Follows patterns from Git, VS Code settings

**Why Many-to-Many Codex-Context?**
- Character bio appears in both story context AND research context
- Code file appears in both implementation context AND documentation context
- Avoid duplication, allow multi-faceted content

**Why File-backed Codices?**
- Task system needs .md files for human editing
- Code management needs .ts/.rs files for IDE features
- Content in filesystem, metadata in database
- See ADR-012: Codices as File Containers

---

## üé¨ To Continue

**For next session**: Use `/resume` command to load this handover.

**Immediate Next Steps**:
1. Run `/resume` to confirm handover loaded
2. Set up todo list with Stage 0 tasks
3. Launch Subagent 1 (Database Schema Refactoring) with Task tool
4. Review subagent output, integrate changes
5. Launch Subagent 2 (Global Registry) while testing subagent 1 work
6. Continue orchestrating subagents through Stage 0

**Starting File**: [src/services/bindery/BinderyService.ts](../../vespera-forge/src/services/bindery/BinderyService.ts)

**Starting Command**:
```bash
# First, push the 29 commits from this session
git push origin feat/codex-ui-framework

# Then read current schema
cat src/services/bindery/BinderyService.ts | grep -A 20 "CREATE TABLE"
```

**Current Phase**: Phase 17 - Codex Editor Implementation & System Polish
**Current Stage**: Stage 0 - Architectural Refactoring (not started)
**Branch**: `feat/codex-ui-framework`
**Commits Ahead**: 29 (ready to push)

---

## üìù Session Notes

**Key Insights from This Session**:
- Discovered conceptual mismatch in Phase 16b (Projects ‚Üí Contexts)
- Identified need for three-level hierarchy during editor planning
- Realized file-backed Codices need filesystem storage for content
- User wants to use subagent orchestration for implementation (smart!)

**User Preferences Noted**:
- Prefers auto-save eventually (will implement manual save first)
- Wants templates to enforce modular content via size limits
- Plans to use CRDT infrastructure for collaborative editing
- Wants virtualization from the start for performance

**Commands Created This Session**:
- `/resume` - Load previous session's handover (NEW)

**Conversation Flow**:
1. Started with `/phase-start` - user reported editor bug
2. During planning, discovered file storage architecture question
3. User insight: "Projects" are actually "Contexts" within projects
4. Proposed three-level hierarchy (Workspace ‚Üí Project ‚Üí Context)
5. User approved, requested ADRs
6. Created ADR-015, ADR-016, updated Phase 17 plan
7. User requested `/resume` command for next session
8. Created command and this handover

**Why New Context Makes Sense**:
- Architectural discussion complete (heavy context usage)
- Clear implementation plan with discrete tasks
- Perfect for subagent orchestration
- Fresh context = more room for code changes
