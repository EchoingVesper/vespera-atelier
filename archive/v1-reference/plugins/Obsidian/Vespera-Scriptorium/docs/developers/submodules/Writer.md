# Writer Module

**Role in Processing Pipeline:** Functions as a terminal or output node responsible for formatting and writing processed results, such as LLM outputs, to files.

## Overview

Within the new n8n-inspired processing pipeline architecture, the Writer module serves as a dedicated output node. Its primary function is to take the results generated by upstream processing nodes (like the LLMClient node, potentially after aggregation or further transformation) and persist them to the user's Obsidian vault as formatted files. It handles the complexities of file path determination, directory management, metadata inclusion, and ensuring the final output is correctly saved according to user or pipeline configuration.

## Interfaces and Types

### Exported Interfaces

- `Writer`: Interface for writing summaries to files
  ```typescript
  interface Writer {
    writeSummary(summary: SummaryContent): Promise<string>;
    getSummaryPath(fileName: string): string;
  }
  ```

- `WriterConfig`: Configuration for creating a Writer instance
  ```typescript
  interface WriterConfig {
    app: App;
    settings: VesperaScriptoriumSettings;
  }
  ```

- `SummaryContent`: Content to be written to a summary file
  ```typescript
  interface SummaryContent {
    fileName: string;
    content: string;
    metadata: SummaryMetadata;
  }
  ```

- `SummaryMetadata`: Metadata for the summary
  ```typescript
  interface SummaryMetadata {
    sourceFile: string;
    date: Date;
    model: string;
    prompt: string;
  }
  ```

### Factory Function

- `createWriter(config: WriterConfig): Writer`: Creates a new Writer instance

## Pipeline Integration

The Writer node is typically positioned at or near the end of a processing workflow. It receives input data, which represents the final or intermediate results from preceding nodes. This input is often delivered via a file-based queue managed by the pipeline orchestrator. Upon receiving the data, the Writer node formats it, applies configured metadata and frontmatter, determines the appropriate output file path based on settings, and writes the content to the file system. The pipeline orchestrator is responsible for directing the processed data to the Writer node and confirming the successful completion of the write operation.

## Features as a Pipeline Output Node

The Writer node provides several key features essential for its role as a pipeline output:

### Configurable Output Locations

The destination for the output files written by the Writer node is highly configurable, allowing the pipeline to save results to different locations within the user's vault based on the workflow's requirements:

1.  **Summaries Folder** (`summaries-folder`): Writes output files to a designated `/Summaries` folder in the vault root.
2.  **Original Location** (`original-location`): Saves output files in the same directory as the original source file that initiated the processing.
3.  **Custom Path** (`custom-path`): Allows specifying an arbitrary path within the vault for saving output files.

These output locations are determined by the pipeline's configuration for the Writer node.

### Metadata and Frontmatter

The Writer node can include configurable YAML frontmatter in the output files, embedding relevant metadata about the processing operation. This metadata, which can include details like the source file, processing date, LLM model used, and prompt, enhances the discoverability and context of the generated output within Obsidian, particularly for tools like Dataview.

Metadata options are controlled by the pipeline's configuration for the Writer node.

### File Naming

The naming convention for the output files is configurable, typically allowing for the inclusion of the original source file name as a placeholder (`{original}`) to maintain a clear link between input and output.

The file name format is specified in the pipeline's configuration for the Writer node.

### Error Handling

Robust error handling is built into the Writer node to ensure reliable output. It can automatically create necessary directories, handle potential file conflicts (with optional user confirmation), and provide detailed error messages to the pipeline orchestrator if writing fails. This allows the pipeline to manage output persistence reliably.

## Implementation Details

### Path Determination

The `getSummaryPath` method determines where a summary file should be written based on the output location setting:

```typescript
getSummaryPath(fileName: string): string {
  // Extract base name without extension
  const baseName = fileName.replace(/\.[^/.]+$/, "");

  // Format the file name according to settings
  const formattedName = this.settings.writer.fileNameFormat
    .replace('{original}', baseName);

  // Determine output path based on settings
  let outputPath: string;

  switch (this.settings.writer.outputLocation) {
    case 'original-location':
      // Get directory of original file
      const directory = fileName.substring(0, fileName.lastIndexOf('/') + 1);
      outputPath = `${directory}${formattedName}.md`;
      break;

    case 'custom-path':
      // Use custom path from settings
      const customPath = this.settings.writer.customPath || 'Summaries';
      outputPath = `${customPath}/${formattedName}.md`;
      break;

    case 'summaries-folder':
    default:
      // Use default Summaries folder
      outputPath = `Summaries/${formattedName}.md`;
      break;
  }

  // Normalize path for cross-platform compatibility
  return normalizePath(outputPath);
}
```

### Content Formatting

The module formats the summary content with frontmatter and a heading:

```typescript
private formatSummaryContent(summary: SummaryContent): string {
  // Start with frontmatter
  let content = '---\n';

  // Add metadata if enabled
  if (this.settings.writer.includeMetadata) {
    content += `source: "${summary.metadata.sourceFile}"\n`;

    if (this.settings.writer.metadataOptions.includeDate) {
      content += `date: ${summary.metadata.date.toISOString()}\n`;
    }

    if (this.settings.writer.metadataOptions.includeModel) {
      content += `model: "${summary.metadata.model}"\n`;
    }

    if (this.settings.writer.metadataOptions.includePrompt) {
      // Escape any quotes in the prompt
      const escapedPrompt = summary.metadata.prompt.replace(/"/g, '\\"');
      content += `prompt: "${escapedPrompt}"\n`;
    }

    // Add tags for Dataview compatibility
    content += 'tags: [vespera-summary]\n';
  }

  // Close frontmatter
  content += '---\n\n';

  // Add heading with original file name
  content += `# Summary of ${summary.fileName}\n\n`;

  // Add the summary content
  content += summary.content;

  return content;
}
```

## Usage within the Pipeline

Within the n8n-inspired pipeline, the Writer module is instantiated and invoked by the pipeline orchestrator or a preceding node responsible for the final output stage. The orchestrator provides the Writer node with the processed data (`SummaryContent` or similar structure) and the necessary configuration (output location, file naming, metadata options). The Writer node then executes the file writing operation as part of the overall workflow.

## Integration with Main Workflow

The Writer module is integrated into the main workflow in `main.ts`:

1. After LLM processing is complete, a Writer instance is created
2. For each processed file, a SummaryContent object is created with the file name, summary content, and metadata
3. The summary is written to a file using the Writer's `writeSummary` method
4. The path of the written file is returned and displayed to the user

## Usage Example

```typescript
// Create a writer instance
const writer = createWriter({
  app: this.app,
  settings: this.settings
});

// Create summary content
const summaryContent: SummaryContent = {
  fileName: "document.md",
  content: "This is a summary of the document.",
  metadata: {
    sourceFile: "document.md",
    date: new Date(),
    model: "llama2",
    prompt: "Summarize this document"
  }
};

// Write the summary to a file
const filePath = await writer.writeSummary(summaryContent);
console.log(`Summary written to: ${filePath}`);
```

## Testing

The Writer module has comprehensive unit tests that verify:
- Path generation for different output locations
- Metadata inclusion/exclusion based on settings
- Directory creation for nested paths
- Error handling for file conflicts
- Special character handling in metadata
- Cross-platform path normalization

---
