# Writer Module

**Responsibility:** Aggregates LLM output and writes Markdown summaries to configurable locations.

## Overview

The Writer module is responsible for taking summarized content generated by the LLM and writing it to files in the user's vault. It handles file path determination, directory creation, metadata formatting, and error handling to ensure summaries are properly saved and organized.

## Interfaces and Types

### Exported Interfaces

- `Writer`: Interface for writing summaries to files
  ```typescript
  interface Writer {
    writeSummary(summary: SummaryContent): Promise<string>;
    getSummaryPath(fileName: string): string;
  }
  ```

- `WriterConfig`: Configuration for creating a Writer instance
  ```typescript
  interface WriterConfig {
    app: App;
    settings: VesperaScriptoriumSettings;
  }
  ```

- `SummaryContent`: Content to be written to a summary file
  ```typescript
  interface SummaryContent {
    fileName: string;
    content: string;
    metadata: SummaryMetadata;
  }
  ```

- `SummaryMetadata`: Metadata for the summary
  ```typescript
  interface SummaryMetadata {
    sourceFile: string;
    date: Date;
    model: string;
    prompt: string;
  }
  ```

### Factory Function

- `createWriter(config: WriterConfig): Writer`: Creates a new Writer instance

## Features

### Configurable Output Locations

The Writer module supports three output location options:

1. **Summaries Folder** (`summaries-folder`): Writes summaries to a `/Summaries` folder in the vault root
2. **Original Location** (`original-location`): Writes summaries to the same folder as the original file
3. **Custom Path** (`custom-path`): Writes summaries to a user-specified path

Configuration is done through the settings:

```typescript
settings.writer.outputLocation = 'summaries-folder'; // or 'original-location' or 'custom-path'
settings.writer.customPath = 'Custom/Summaries'; // Used when outputLocation is 'custom-path'
```

### Metadata and Frontmatter

Summaries include YAML frontmatter with configurable metadata:

```yaml
---
source: "original-file.md"
date: "2025-04-30T13:09:37.000Z"
model: "llama2"
prompt: "Summarize this content"
tags: [vespera-summary]
---
```

Metadata options can be enabled/disabled in settings:
- Source file (always included when metadata is enabled)
- Date
- Model
- Prompt
- Tags (always includes `vespera-summary` when metadata is enabled)

Configuration is done through the settings:

```typescript
settings.writer.includeMetadata = true; // Enable/disable all metadata
settings.writer.metadataOptions = {
  includeDate: true,
  includeModel: true,
  includePrompt: true
};
```

### File Naming

File names follow a configurable format using the `{original}` placeholder:
- Default: `{original}_summary.md`
- Example: `my-document_summary.md`

Configuration is done through the settings:

```typescript
settings.writer.fileNameFormat = '{original}_summary'; // Default format
```

### Error Handling

The Writer module includes robust error handling:
- Creates directories if they don't exist (including nested directories)
- Handles file conflicts with optional overwrite confirmation
- Provides detailed error messages
- Properly escapes special characters in metadata (e.g., quotes in prompts)
- Normalizes paths for cross-platform compatibility

Configuration for overwrite confirmation:

```typescript
settings.writer.confirmOverwrite = true; // Prompt before overwriting existing files
```

## Implementation Details

### Path Determination

The `getSummaryPath` method determines where a summary file should be written based on the output location setting:

```typescript
getSummaryPath(fileName: string): string {
  // Extract base name without extension
  const baseName = fileName.replace(/\.[^/.]+$/, "");
  
  // Format the file name according to settings
  const formattedName = this.settings.writer.fileNameFormat
    .replace('{original}', baseName);
  
  // Determine output path based on settings
  let outputPath: string;
  
  switch (this.settings.writer.outputLocation) {
    case 'original-location':
      // Get directory of original file
      const directory = fileName.substring(0, fileName.lastIndexOf('/') + 1);
      outputPath = `${directory}${formattedName}.md`;
      break;
      
    case 'custom-path':
      // Use custom path from settings
      const customPath = this.settings.writer.customPath || 'Summaries';
      outputPath = `${customPath}/${formattedName}.md`;
      break;
      
    case 'summaries-folder':
    default:
      // Use default Summaries folder
      outputPath = `Summaries/${formattedName}.md`;
      break;
  }
  
  // Normalize path for cross-platform compatibility
  return normalizePath(outputPath);
}
```

### Content Formatting

The module formats the summary content with frontmatter and a heading:

```typescript
private formatSummaryContent(summary: SummaryContent): string {
  // Start with frontmatter
  let content = '---\n';
  
  // Add metadata if enabled
  if (this.settings.writer.includeMetadata) {
    content += `source: "${summary.metadata.sourceFile}"\n`;
    
    if (this.settings.writer.metadataOptions.includeDate) {
      content += `date: ${summary.metadata.date.toISOString()}\n`;
    }
    
    if (this.settings.writer.metadataOptions.includeModel) {
      content += `model: "${summary.metadata.model}"\n`;
    }
    
    if (this.settings.writer.metadataOptions.includePrompt) {
      // Escape any quotes in the prompt
      const escapedPrompt = summary.metadata.prompt.replace(/"/g, '\\"');
      content += `prompt: "${escapedPrompt}"\n`;
    }
    
    // Add tags for Dataview compatibility
    content += 'tags: [vespera-summary]\n';
  }
  
  // Close frontmatter
  content += '---\n\n';
  
  // Add heading with original file name
  content += `# Summary of ${summary.fileName}\n\n`;
  
  // Add the summary content
  content += summary.content;
  
  return content;
}
```

## Integration with Main Workflow

The Writer module is integrated into the main workflow in `main.ts`:

1. After LLM processing is complete, a Writer instance is created
2. For each processed file, a SummaryContent object is created with the file name, summary content, and metadata
3. The summary is written to a file using the Writer's `writeSummary` method
4. The path of the written file is returned and displayed to the user

## Usage Example

```typescript
// Create a writer instance
const writer = createWriter({
  app: this.app,
  settings: this.settings
});

// Create summary content
const summaryContent: SummaryContent = {
  fileName: "document.md",
  content: "This is a summary of the document.",
  metadata: {
    sourceFile: "document.md",
    date: new Date(),
    model: "llama2",
    prompt: "Summarize this document"
  }
};

// Write the summary to a file
const filePath = await writer.writeSummary(summaryContent);
console.log(`Summary written to: ${filePath}`);
```

## Testing

The Writer module has comprehensive unit tests that verify:
- Path generation for different output locations
- Metadata inclusion/exclusion based on settings
- Directory creation for nested paths
- Error handling for file conflicts
- Special character handling in metadata
- Cross-platform path normalization

---
